# OAuth 2.0 Integration

This document provides the steps for partners to integrate their applications to Mocaverse using OAuth 2.0 (Authorization Code Flow).

## Steps

### 1. Application Registration

- Provide `redirect_uri` values to our team (e.g. https://your-app.example.com/callback)
- Obtain the `client_id` and `client_secret` from our team

### 2. User Authorization Request

#### Request

```
GET https://oauth.mocaverse.xyz/api/oauth/auth
```

When performing authorization request, specify the following `application/x-www-form-urlencoded` parameters

| Parameter       | Description                                                                     |
|-----------------|---------------------------------------------------------------------------------|
| `response_type` | must be set to `code`                                                           |
| `client_id`     | `client_id` from [step 1](#1-application-registration)                          |
| `redirect_uri`  | One of the registered `redirect_uri` from [step 1](#1-application-registration) |
| `state`         | a random string generated by your app to prevent CSRF attacks                   |

```html
<!--
| URI Component | Example Value                         |
|---------------|---------------------------------------|
| response_type | code                                  |
| client_id     | b6084afa-e9ee-4eb4-8220-338be0c12374  |
| redirect_uri  | https://your-app.example.com/callback |
| state         | v6glrJn3gf3qL4rPFLBB                  |
-->

<a href="https://oauth.mocaverse.xyz/api/oauth/auth?response_type=code&client_id=b6084afa-e9ee-4eb4-8220-338be0c12374&redirect_uri=https%3A%2F%2Fyour-app.example.com%2Fcallback&state=v6glrJn3gf3qL4rPFLBB">
  Login with Mocaverse
</a>
```

#### Response

| Response | Description                                                                     | Sample Response               |
|----------|---------------------------------------------------------------------------------|-------------------------------|
| 302      | **Valid** `redirect_uri`. Errors are redirected to the provided `redirect_uri`. | *(Refer to Response A below)* |
| 400      | **Invalid** `redirect_uri`. Errors are directly returned as json body payload.  | *(Refer to Response B below)* |

**Note:** `redirect_uri` is only considered as valid, if the value used is registered under the corresponding `client_id` (Partner) used.

> **Examples**
>
> `client_1` (`client_id`) has the following registered `redirect_uri`'s:
>   - https://your-app.example.com/callback1
>   - https://your-app.example.com/callback2
>
> The following are considered **valid**:
>   -  `client_id=client_1` and `redirect_uri=https%3A%2F%2Fyour-app.example.com%2Fcallback1`
>   -  `client_id=client_1` and `redirect_uri=https%3A%2F%2Fyour-app.example.com%2Fcallback2`
>
> The following are considered **invalid**:
>   -  `client_id=client_1` and `redirect_uri=https%3A%2F%2Fyour-app.example.com%2Fcallback3` (callback**3**)
>   -  `client_id=client_1` and `redirect_uri=https%3A%2F%2Fgoogle.com`
>   -  `client_id=client_2` and `redirect_uri=https%3A%2F%2Fyour-app.example.com%2Fcallback1` (wrong `client_id`)
>   -  *(Wrong `client_id` automatically means wrong `redirect_uri`.)*

**Response A**

```
https://your-app.example.com/callback?error=unsupported_response_type&error_description=only+supports%3A+code&state=dK6fRBNVY1HM2GQ4aBwM
```

**Response B**

```json
{
  "error": "invalid_request",
  "error_description": "invalid client_id",
  "state": "dK6fRBNVY1HM2GQ4aBwM"
}
```

| Field               | Description                                 |
|---------------------|---------------------------------------------|
| `error`             | [Error Code Reference](#oauth2-error-codes) |
| `error_description` | Error details/summary                       |
| `state`             | The `state`                                 |

### 3. User Authorization

The user will be redirected to log in and authorize your app on Mocaverse's site.

### 4. Authorization Code Redirect Callback

If the user **approves** the authorization request, they will be redirected back to your `redirect_uri` containing a one-time use authorization `code` and the provided `state` from [step 2](#2-user-authorization-request).

```
https://your-app.example.com/callback?code=602cbbe1-60dd-482f-b0d8-329f5f1254c7&state=v6glrJn3gf3qL4rPFLBB
```

If the user **denies** the authorization request, the user will be redirected to your `redirect_uri` containing an `access_denied` error and the provided `state` from [step 2](#2-user-authorization-request).

```
https://your-app.example.com/callback?error=access_denied&state=E0BXkRkKnvqMiDdYC8MW
```

**Important:** Validating the `state` if the value matches with the initial request during the User Authorization Request is strongly recommended.

### 5. Access Token Request

#### Request

Request the `access_token` via `POST https://oauth.mocaverse.xyz/api/oauth/token` with the following `application/x-www-form-urlencoded` parameters:

| Parameter       | Description                                                                            |
|-----------------|----------------------------------------------------------------------------------------|
| `grant_type`    | must be `authorization_code`                                                           |
| `client_id`     | must be the provided `client_id` from [step 1](#1-application-registration)            |
| `client_secret` | must be the provided `client_secret` from [step 1](#1-application-registration)        |
| `code`          | the authorization code received from [step 4](#4-authorization-code-redirect-callback) |
| `redirect_uri`  | must match the same value used during [step 2](#2-user-authorization-request)          |

#### Response

| Response | Description | Sample Response               |
|----------|-------------|-------------------------------|
| 200      | Successful  | *(Refer to Response A below)* |
| 400      | Bad Request | *(Refer to Response B below)* |

**Response A**

```json
{
  "access_token": "...",
  "token_type": "bearer"
}
```

**Response B**

```json
{
  "error": "invalid_request",
  "error_description": "invalid auth code"
}
```

| Field               | Description                                      |
|---------------------|--------------------------------------------------|
| `access_token`      | JWT to be used for `Authorization: Bearer <JWT>` |
| `token_type`        | Type of token                                    |
| `error`             | [Error Code Reference](#oauth2-error-codes)      |
| `error_description` | Error details/summary                            |

* * *

## OAuth2 APIs

### Partner User Registration

Link a user id on your platform to a user in Mocaverse.

#### Request

```
POST https://api.moca-id.mocaverse.xyz/api/partner/add-user
```

Request Headers:

| Header          | Description             |
|-----------------|-------------------------|
| `Authorization` | `Bearer <access_token>` |
| `Content-Type`  | `application/json`      |

Request Body Parameters:

| Parameter         | Description                                                                       |
|-------------------|-----------------------------------------------------------------------------------|
| `partnerUserId`   | Their unqiue User ID in your system (e.g. `2c55dc7d-5715-4cb9-9801-f62498c02077`) |
| `partnerUserName` | Their Display name in your system (e.g. `gamertag123`)                            |

#### Response

| Response | Description                                           | Sample Response                                                                              |
|----------|-------------------------------------------------------|----------------------------------------------------------------------------------------------|
| 200      | Successfully registered or user is already registered | *(Refer to Response A below)*                                                                  |
| 400      | Bad Request                                           | *(Refer to Response B below)*                                                                  |
| 401      | Unauthorized Access                                   | *(Refer to: [OAuth2 API Unauthorized Response: 401](#oauth2-api-unauthorized-response-401))* |

**Response A**

```json
{
  "existingUser": "f1925118-2b20-435c-994c-9f7e5fb812c4"
}
```

**Response B**

```json
{
  "error": "invalid_param",
  "message": "A different user ID has been linked to your Moca ID."
}
```

### User Realm ID

Getting the Realm ID of a user.

#### Request

```
GET https://api.moca-id.mocaverse.xyz/api/partner/user
```

Request Headers:

| Header          | Description             |
|-----------------|-------------------------|
| `Authorization` | `Bearer <access_token>` |

#### Response

| Response | Description                                | Sample Response                                                                              |
|----------|--------------------------------------------|----------------------------------------------------------------------------------------------|
| 200      | Realm Id if user is linked, null otherwise | `{ "realmId": "user.moca" }` or `{ "realmId": null }`                                        |
| 401      | Unauthorized Access                        | *(Refer to: [OAuth2 API Unauthorized Response: 401](#oauth2-api-unauthorized-response-401))* |

### User Sales Eligibility

* * *

Getting sales eligibility info of a user.

#### Request

```
GET https://api.moca-id.mocaverse.xyz/api/partner/eligibility
```

Request Headers:

- `Authorization: Bearer <access_token>`

#### Response

| Response | Description         | Sample Response                                                                              |
|----------|---------------------|----------------------------------------------------------------------------------------------|
| 200      | Mocaverse RealId    | *(Refer to: Response A)*                                                                     |
| 401      | Unauthorized Access | *(Refer to: [OAuth2 API Unauthorized Response: 401](#oauth2-api-unauthorized-response-401))* |

**Response A**

```json
{
  "realmId": "user.moca",
  "guarenteed": 4200,
  "waitlisted": 300,
  "description": "You qualify for guaranteed token allocation of up to USD4200, and an additional waitlisted allocation up to USD300 through a raffle if there's under allocation. Refer to the token sale rules for details."
}
```

| Field         | Description                  |
|---------------|------------------------------|
| `realmId`     | User Realm ID                |
| `guaranteed`  | Guaranteed Allocation        |
| `waitlisted`  | Waitlisted Allocation        |
| `description` | Eligibility text description |

* * *

### References

#### Oauth2 Error Codes

**Reference:** [rfc6749](https://datatracker.ietf.org/doc/html/rfc6749)

```
access_denied
    The resource owner or authorization server denied the
    request.

invalid_request
    The request is missing a required parameter, includes an
    unsupported parameter value (other than grant type),
    repeats a parameter, includes multiple credentials,
    utilizes more than one mechanism for authenticating the
    client, or is otherwise malformed.

invalid_client
    Client authentication failed (e.g., unknown client, no
    client authentication included, or unsupported
    authentication method).  The authorization server MAY
    return an HTTP 401 (Unauthorized) status code to indicate
    which HTTP authentication schemes are supported.  If the
    client attempted to authenticate via the "Authorization"
    request header field, the authorization server MUST
    respond with an HTTP 401 (Unauthorized) status code and
    include the "WWW-Authenticate" response header field
    matching the authentication scheme used by the client.

invalid_grant
    The provided authorization grant (e.g., authorization
    code, resource owner credentials) or refresh token is
    invalid, expired, revoked, does not match the redirection
    URI used in the authorization request, or was issued to
    another client.

unauthorized_client
    The authenticated client is not authorized to use this
    authorization grant type.

unsupported_grant_type
    The authorization grant type is not supported by the
    authorization server.

unsupported_response_type
    The authorization server does not support obtaining an
    authorization code using this method.

invalid_scope
    The requested scope is invalid, unknown, malformed, or
    exceeds the scope granted by the resource owner.

server_error
    The authorization server encountered an unexpected
    condition that prevented it from fulfilling the request.
    (This error code is needed because a 500 Internal Server
    Error HTTP status code cannot be returned to the client
    via an HTTP redirect.)

temporarily_unavailable
    The authorization server is currently unable to handle
    the request due to a temporary overloading or maintenance
    of the server.  (This error code is needed because a 503
    Service Unavailable HTTP status code cannot be returned
    to the client via an HTTP redirect.)
```

#### OAuth2 API Unauthorized Response: 401

```
{
  "error": "client_error",
  "message": "invalid signature" | "invalid token" | "No auth token"
}
```

| `message`         | Description                               |
|-------------------|-------------------------------------------|
| invalid signature | Signature of the auth token is invalid    |
| invalid token     | Auth token is malformed                   |
| No auth token     | `Authorization: Bearer` header is missing |
